<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Examples · AccelInterfaces</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">AccelInterfaces</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Julia AccelInterfaces.jl (<strong>Jai</strong>)</a></li><li><a class="tocitem" href="../api/">Jai API</a></li><li class="is-active"><a class="tocitem" href>Examples</a><ul class="internal"><li><a class="tocitem" href="#Simple-OpenAcc-example"><span>Simple OpenAcc example</span></a></li><li><a class="tocitem" href="#Further-readings"><span>Further readings</span></a></li></ul></li><li><a class="tocitem" href="../guide/">Getting-Started</a></li><li><a class="tocitem" href="../jlweather/">jlweather</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Examples</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Examples</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/grnydawn/AccelInterfaces.jl/blob/master/docs/src/man/examples.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Examples"><a class="docs-heading-anchor" href="#Examples">Examples</a><a id="Examples-1"></a><a class="docs-heading-anchor-permalink" href="#Examples" title="Permalink"></a></h1><h2 id="Simple-OpenAcc-example"><a class="docs-heading-anchor" href="#Simple-OpenAcc-example">Simple OpenAcc example</a><a id="Simple-OpenAcc-example-1"></a><a class="docs-heading-anchor-permalink" href="#Simple-OpenAcc-example" title="Permalink"></a></h2><h3 id="Preparing-an-OpenACC-code"><a class="docs-heading-anchor" href="#Preparing-an-OpenACC-code">Preparing an OpenACC code</a><a id="Preparing-an-OpenACC-code-1"></a><a class="docs-heading-anchor-permalink" href="#Preparing-an-OpenACC-code" title="Permalink"></a></h3><p>User can specify the function body code using Julia string that contains the code, or a Julia string that points to Jai Kernel File(.knl) in simple text format. The following Julia code calculates a vector sum, whose main algorithm is written in Fortran OpenACC.</p><pre><code class="language-julia hljs"># main.jl

using AccelInterfaces

kernel_text = &quot;&quot;&quot;
[fortran_openacc]
    INTEGER i

    !\$acc parallel loop 
    DO i=LBOUND(x, 1), UBOUND(x, 1)
        z(i) = x(i) + y(i)
    END DO
    !\$acc end parallel loop
&quot;&quot;&quot;</code></pre><p>The &quot;kernel_text&quot; string contains a Fortran DO loop that actually calculates the vector sum. OpenACC annotations surround the DO loop, and the header at the top of the string specifies that the code contains both of Fortran OpenACC code.</p><h3 id="Annotating-Julia-main-code-with-Jai-macros"><a class="docs-heading-anchor" href="#Annotating-Julia-main-code-with-Jai-macros">Annotating Julia main code with Jai macros</a><a id="Annotating-Julia-main-code-with-Jai-macros-1"></a><a class="docs-heading-anchor-permalink" href="#Annotating-Julia-main-code-with-Jai-macros" title="Permalink"></a></h3><p>Once &quot;embedded&quot; code is ready as explained in previous section, we need to use Jai macros to drive the execution of the embedded code.</p><pre><code class="language-julia hljs">    # continued from previous Julia code

    const N = 10
    x = fill(1, N)
    y = fill(2, N)
    z = fill(0, N)
    answer = fill(3, N)

    @jkernel kernel_text mykernel framework(fortran_openacc=&quot;ftn -h acc,noomp -fPIC -shared&quot;)

    @jenterdata alloc(x, y, z) updateto(x, y)

    @jlaunch mykerne input(x, y)  output(z)

    @jexitdata updatefrom(z) delete(x, y, z)

    @jdecel

    @assert z == answer</code></pre><h4 id="Creates-a-Jai-accelerator-context"><a class="docs-heading-anchor" href="#Creates-a-Jai-accelerator-context">Creates a Jai accelerator context</a><a id="Creates-a-Jai-accelerator-context-1"></a><a class="docs-heading-anchor-permalink" href="#Creates-a-Jai-accelerator-context" title="Permalink"></a></h4><p>The @jaccel directive creates a Jai accelerator context.</p><h4 id="Creates-a-Jai-kernel-context"><a class="docs-heading-anchor" href="#Creates-a-Jai-kernel-context">Creates a Jai kernel context</a><a id="Creates-a-Jai-kernel-context-1"></a><a class="docs-heading-anchor-permalink" href="#Creates-a-Jai-kernel-context" title="Permalink"></a></h4><p>The @jkernel directive creates a Jai kernel context. As a first caluse of @jkernel, users should specify the Jai Kernel through a Julia string as in this example. Alternatively, the user can provide Jai with a path string to a text file that contains the kernel. To identify the kernel context, we use the literal name mykernel.</p><p>The framework clause specifies the kind of acceleration, which in this example is Fortran OpenACC. The user can provide Jai with the actual compiler command line to generate a shared library. The command line should include the compiler and all compiler flags, except the -o flag, which specifies the name of the output file and the path to the input source file.</p><h4 id="Allocate-GPU-memory-and-copy-data-from-Julia-Arrays-to-GPU-memory"><a class="docs-heading-anchor" href="#Allocate-GPU-memory-and-copy-data-from-Julia-Arrays-to-GPU-memory">Allocate GPU memory and copy data from Julia Arrays to GPU memory</a><a id="Allocate-GPU-memory-and-copy-data-from-Julia-Arrays-to-GPU-memory-1"></a><a class="docs-heading-anchor-permalink" href="#Allocate-GPU-memory-and-copy-data-from-Julia-Arrays-to-GPU-memory" title="Permalink"></a></h4><p>The @jenterdata directive is used to allocate GPU memory and copy data from CPU to GPU. Once the user adds Julia variable names, Jai uses the data movement API according to the framework used, OpenACC in this case.</p><h4 id="Launches-a-kernel"><a class="docs-heading-anchor" href="#Launches-a-kernel">Launches a kernel</a><a id="Launches-a-kernel-1"></a><a class="docs-heading-anchor-permalink" href="#Launches-a-kernel" title="Permalink"></a></h4><p>The first argument to the @jlaunch directive is the name of the kernel context used in the @jkernel directive. The user then adds the names of variables to the input and output clauses accordingly. However, it is important to note that you should only use simple variable names for inputs and outputs to/from the kernel in the @jlaunch directive. For example, you cannot write something like this:</p><pre><code class="language-julia hljs">@jlaunch mykernel input(x+1, func(y)) output(z::Vector) # Jai Syntax Error</code></pre><h4 id="Copy-data-from-GPU-memory-to-Julia-Arrays-and-deallocate-GPU-memory"><a class="docs-heading-anchor" href="#Copy-data-from-GPU-memory-to-Julia-Arrays-and-deallocate-GPU-memory">Copy data from GPU memory to Julia Arrays and deallocate GPU memory</a><a id="Copy-data-from-GPU-memory-to-Julia-Arrays-and-deallocate-GPU-memory-1"></a><a class="docs-heading-anchor-permalink" href="#Copy-data-from-GPU-memory-to-Julia-Arrays-and-deallocate-GPU-memory" title="Permalink"></a></h4><p>The @jexitdata directive is used to deallocate GPU memory and copy data from GPU to CPU. Once the user adds Julia variable names, Jai uses the data movement API according to the framework used, OpenACC in this case.</p><h4 id="Remove-a-Jai-accelerator-context"><a class="docs-heading-anchor" href="#Remove-a-Jai-accelerator-context">Remove a Jai accelerator context</a><a id="Remove-a-Jai-accelerator-context-1"></a><a class="docs-heading-anchor-permalink" href="#Remove-a-Jai-accelerator-context" title="Permalink"></a></h4><p>Lastly, &quot;@jdecel&quot; is used to declare the end of the Jai accelerator context.</p><h3 id="Running-the-Julia-main-code"><a class="docs-heading-anchor" href="#Running-the-Julia-main-code">Running the Julia main code</a><a id="Running-the-Julia-main-code-1"></a><a class="docs-heading-anchor-permalink" href="#Running-the-Julia-main-code" title="Permalink"></a></h3><p>Run the Julia main. During the first run, Jai will genrate a shared library and load the shared library and finally make a call to the function in the shared library. This process is done automatically and takes some time at the first run. Howver, once the process is finished with success, the generated shared library is cached and will be loaded immediately unless there is no change.</p><pre><code class="language-bash hljs">&gt; julia main.jl</code></pre><h2 id="Further-readings"><a class="docs-heading-anchor" href="#Further-readings">Further readings</a><a id="Further-readings-1"></a><a class="docs-heading-anchor-permalink" href="#Further-readings" title="Permalink"></a></h2><p><a href="../jlweather/#jlweather">jlweather</a> : Jai implementations of <a href="https://github.com/mrnorman/miniWeather">miniWeather</a></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../api/">« Jai API</a><a class="docs-footer-nextpage" href="../guide/">Getting-Started »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Monday 24 July 2023 21:09">Monday 24 July 2023</span>. Using Julia version 1.9.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
